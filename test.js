let a = {
    "binance": {
        "STRK/USDT:USDT": {
            "exchange": "binance",
            "symbol": "STRK/USDT:USDT",
            "markPrice": 0.13041955,
            "fundingRate": 0.00005,
            "fundingRateFormat": "0.0050%",
            "nextFundingTime": "1746633600000",
            "nextFundingTimeFormat": "00:00:00"
        },
        "LAYER/USDT:USDT": {
			"exchange": "binance",
			"symbol": "LAYER/USDT:USDT",
			"markPrice": 1.693,
			"fundingRate": -0.0067777,
			"fundingRateFormat": "-0.6778%",
			"nextFundingTime": "1746630000000",
			"nextFundingTimeFormat": "23:00:00"
		},
        "1INCH/USDT:USDT": {
            "exchange": "binance",
            "symbol": "1INCH/USDT:USDT",
            "markPrice": 0.18983311,
            "fundingRate": -0.00002116,
            "fundingRateFormat": "-0.0021%",
            "nextFundingTime": "1746633600000",
            "nextFundingTimeFormat": "00:00:00"
        },
        "BOME/USDT:USDT": {
			"exchange": "binance",
			"symbol": "BOME/USDT:USDT",
			"markPrice": 0.00138004,
			"fundingRate": -0.00000927,
			"fundingRateFormat": "-0.0009%",
			"nextFundingTime": "1746633600000",
			"nextFundingTimeFormat": "00:00:00"
		},
		"AI/USDT:USDT": {
			"exchange": "binance",
			"symbol": "AI/USDT:USDT",
			"markPrice": 0.14614088,
			"fundingRate": 0.00005,
			"fundingRateFormat": "0.0050%",
			"nextFundingTime": "1746633600000",
			"nextFundingTimeFormat": "00:00:00"
		},
        "MOVR/USDT:USDT": {
			"exchange": "binance",
			"symbol": "MOVR/USDT:USDT",
			"markPrice": 6.12956849,
			"fundingRate": 0.00003863,
			"fundingRateFormat": "0.0039%",
			"nextFundingTime": "1746633600000",
			"nextFundingTimeFormat": "00:00:00"
		},
    },
    "bybit": {
        "STRK/USDT:USDT": {
            "exchange": "bybit",
            "symbol": "STRK/USDT:USDT",
            "markPrice": 0.1303,
            "fundingRate": -0.00012206,
            "fundingRateFormat": "-0.0122%",
            "nextFundingTime": "1746633600000",
            "nextFundingTimeFormat": "00:00:00"
        },
        "BOME/USDT:USDT": {
			"exchange": "bybit",
			"symbol": "BOME/USDT:USDT",
			"markPrice": 0.001379,
			"fundingRate": 0.00005,
			"fundingRateFormat": "0.0050%",
			"nextFundingTime": "1746633600000",
			"nextFundingTimeFormat": "00:00:00"
		},
        "MOVR/USDT:USDT": {
			"exchange": "bybit",
			"symbol": "MOVR/USDT:USDT",
			"markPrice": 6.123,
			"fundingRate": 0.00005,
			"fundingRateFormat": "0.0050%",
			"nextFundingTime": "1746633600000",
			"nextFundingTimeFormat": "00:00:00"
		},

    },
    "gate": {
        "STRK/USDT:USDT": {
            "exchange": "gate",
            "symbol": "STRK/USDT:USDT",
            "markPrice": 0.1304,
            "fundingRate": 0.00005,
            "fundingRateFormat": "0.0050%",
            "interval": "4h",
            "nextFundingTime": 1746633600000,
            "nextFundingTimeFormat": "00:00:00"
        },
        "BOME/USDT:USDT": {
			"exchange": "gate",
			"symbol": "BOME/USDT:USDT",
			"markPrice": 0.001379,
			"fundingRate": -0.00008,
			"fundingRateFormat": "-0.0080%",
			"interval": "4h",
			"nextFundingTime": 1746633600000,
			"nextFundingTimeFormat": "00:00:00"
		},
        "MOVR/USDT:USDT": {
			"exchange": "gate",
			"symbol": "MOVR/USDT:USDT",
			"markPrice": 6.132,
			"fundingRate": -0.000113,
			"fundingRateFormat": "-0.0113%",
			"interval": "4h",
			"nextFundingTime": 1746633600000,
			"nextFundingTimeFormat": "00:00:00"
		},
        "LAYER/USDT:USDT": {
			"exchange": "gate",
			"symbol": "LAYER/USDT:USDT",
			"markPrice": 1.6957,
			"fundingRate": -0.004208,
			"fundingRateFormat": "-0.4208%",
			"interval": "1h",
			"nextFundingTime": 1746630000000,
			"nextFundingTimeFormat": "23:00:00"
		},
    },
    "bitget": {
        "STRK/USDT:USDT": {
            "exchange": "bitget",
            "symbol": "STRK/USDT:USDT",
            "markPrice": 0.1305,
            "fundingRate": 0.00005,
            "fundingRateFormat": "0.0050%",
            "interval": "-",
            "nextFundingTime": "-",
            "nextFundingTimeFormat": "-"
        },
        "BOME/USDT:USDT": {
			"exchange": "bitget",
			"symbol": "BOME/USDT:USDT",
			"markPrice": 0.001381,
			"fundingRate": 0.00005,
			"fundingRateFormat": "0.0050%",
			"interval": "-",
			"nextFundingTime": "-",
			"nextFundingTimeFormat": "-"
		},
        "MOVR/USDT:USDT": {
			"exchange": "bitget",
			"symbol": "MOVR/USDT:USDT",
			"markPrice": 6.128,
			"fundingRate": 0.00005,
			"fundingRateFormat": "0.0050%",
			"interval": "-",
			"nextFundingTime": "-",
			"nextFundingTimeFormat": "-"
		},
        "LAYER/USDT:USDT": {
			"exchange": "bitget",
			"symbol": "LAYER/USDT:USDT",
			"markPrice": 1.6931,
			"fundingRate": -0.006702,
			"fundingRateFormat": "-0.6702%",
			"interval": "-",
			"nextFundingTime": "-",
			"nextFundingTimeFormat": "-"
		},
    }
}

function formatRate(rate) {
    return (rate * 100).toFixed(4) + '%';
  }


  function findArbitrageOpportunities(data) {
    const symbolMap = {};
    for (const [exchange, symbols] of Object.entries(data)) {
      for (const [symbol, info] of Object.entries(symbols)) {
        const fr = info.fundingRate;
        const mp = info.markPrice;
        if (typeof fr !== 'number' || typeof mp !== 'number') continue;
        if (!symbolMap[symbol]) symbolMap[symbol] = [];
        symbolMap[symbol].push({ exchange, fundingRate: fr, markPrice: mp });
      }
    }
  
    const opportunities = [];
    const usedExchangesBySymbol = {};
  
    for (const [symbol, items] of Object.entries(symbolMap)) {
      if (items.length < 2) continue;
      usedExchangesBySymbol[symbol] = new Set();
  
      for (let i = 0; i < items.length; i++) {
        for (let j = i + 1; j < items.length; j++) {
          const e1 = items[i];
          const e2 = items[j];
          const fr1 = e1.fundingRate;
          const fr2 = e2.fundingRate;
  
          if (usedExchangesBySymbol[symbol].has(e1.exchange) || usedExchangesBySymbol[symbol].has(e2.exchange)) {
            continue;
          }
  
          let shortEx, longEx;
  
          if (fr1 >= 0 && fr2 < 0) {
            shortEx = e1; longEx = e2;
          } else if (fr2 >= 0 && fr1 < 0) {
            shortEx = e2; longEx = e1;
          } else if (fr1 > 0 && fr2 > 0) {
            if (fr1 > fr2) { shortEx = e1; longEx = e2; }
            else           { shortEx = e2; longEx = e1; }
          } else if (fr1 < 0 && fr2 < 0) {
            if (fr1 > fr2) { shortEx = e1; longEx = e2; }
            else           { shortEx = e2; longEx = e1; }
          } else {
            continue;
          }
  
          const profitMargin = shortEx.fundingRate - longEx.fundingRate;
        //   const netFundingRate = shortEx.fundingRate + longEx.fundingRate;
          const priceSpread = Math.abs(shortEx.markPrice - longEx.markPrice);
          const avgPrice = (shortEx.markPrice + longEx.markPrice) / 2;
          const priceSpreadRate = priceSpread / avgPrice;
  
          opportunities.push({
            symbol,
            shortExchange: shortEx.exchange,
            // shortRate: shortEx.fundingRate,
            shortRateFormat: formatRate(shortEx.fundingRate),
            longExchange: longEx.exchange,
            // longRate: longEx.fundingRate,
            longRateFormat: formatRate(longEx.fundingRate),
            profitMargin,
            profitMarginFormat: formatRate(profitMargin),
            // netFundingRate,
            // netFundingRateFormat: formatRate(netFundingRate),
            // priceSpreadRate,
            priceSpreadRateFormat: formatRate(priceSpreadRate)
          });
  
          usedExchangesBySymbol[symbol].add(shortEx.exchange);
          usedExchangesBySymbol[symbol].add(longEx.exchange);
        }
      }
    }
  
    return opportunities.sort((a, b) => b.profitMargin - a.profitMargin);
  }
  
  
  
  
  // Run and display results
  const arbOpps = findArbitrageOpportunities(a);

console.table(arbOpps);
