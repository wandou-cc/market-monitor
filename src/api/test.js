let a = {
  bitget: {
    swap: {
      "BTC/USDT:USDT": {
        info: {
          symbol: "BTCUSDT",
          lastPr: "94132.2",
          askPr: "94133.7",
          bidPr: "94132.2",
          bidSz: "31.8718",
          askSz: "0.0021",
          high24h: "95165",
          low24h: "93558.6",
          ts: "1746519286012",
          change24h: "-0.00496",
          baseVolume: "87320.649",
          quoteVolume: "8233537361.61632",
          usdtVolume: "8233537361.61632",
          openUtc: "94691",
          changeUtc24h: "-0.0059",
          indexPrice: "94174.7529114716274643",
          fundingRate: "0.000044",
          holdingAmount: "44926.2316",
          deliveryStartTime: null,
          deliveryTime: null,
          deliveryStatus: "",
          open24h: "94601.6",
          markPrice: "94132.2",
        },
        symbol: "BTC/USDT:USDT",
        markPrice: 94132.2,
        indexPrice: 94174.75291147163,
        timestamp: 1746519286012,
        datetime: "2025-05-06T08:14:46.012Z",
        fundingRate: 0.54,
        fundingRateFormat: "0.0044%",
        nextFundingTimeFormat: "-",
        timeFormat: "16:14:46",
      },
      "ETH/USDT:USDT": {
        symbol: "BTC/USDT:USDT",
        markPrice: 0.44276,
        indexPrice: 94174.75291147163,
        timestamp: 1746519286012,
        datetime: "2025-05-06T08:14:46.012Z",
        fundingRate: -0.001246,
        fundingRateFormat: "0.0044%",
        nextFundingTimeFormat: "-",
        timeFormat: "16:14:46",
      },
    },
  },

  gate: {
    swap: {
      "BTC/USDT:USDT": {
        info: {
          funding_rate_indicative: "0.000004",
          mark_price_round: "0.01",
          funding_offset: "0",
          in_delisting: false,
          risk_limit_base: "1000000",
          interest_rate: "0.0003",
          index_price: "94180.94",
          order_price_round: "0.1",
          order_size_min: "1",
          ref_rebate_rate: "0.2",
          name: "BTC_USDT",
          ref_discount_rate: "0",
          order_price_deviate: "0.5",
          maintenance_rate: "0.004",
          mark_type: "index",
          funding_interval: "28800",
          type: "direct",
          risk_limit_step: "1499000000",
          enable_bonus: true,
          enable_credit: true,
          leverage_min: "1",
          funding_rate: "0.000004",
          last_price: "94156.6",
          mark_price: "94156.5",
          order_size_max: "1000000",
          funding_next_apply: "1746547200",
          short_users: "12567",
          config_change_time: "1744372756",
          create_time: "1574035200",
          trade_size: "335726822320",
          position_size: "370956717",
          long_users: "10518",
          quanto_multiplier: "0.0001",
          funding_impact_value: "30000",
          leverage_max: "125",
          cross_leverage_default: "10",
          risk_limit_max: "1500000000",
          maker_fee_rate: "-0.0001",
          taker_fee_rate: "0.00075",
          orders_limit: "100",
          trade_id: "499186350",
          orderbook_id: "81573846736",
          funding_cap_ratio: "0.75",
          voucher_leverage: "2",
          is_pre_market: false,
        },
        symbol: "BTC/USDT:USDT",
        markPrice: 94156.5,
        indexPrice: 94180.94,
        interestRate: 0.0003,
        fundingRate: 0.000004,
        fundingTimestamp: 1746547200000,
        fundingDatetime: "2025-05-06T16:00:00.000Z",
        nextFundingRate: 0.000004,
        interval: "8h",
        fundingRateFormat: "0.0004%",
        nextFundingTimeFormat: "-",
        timeFormat: "16:14:50",
        nextFundingRateFormat: "0.0004%",
      },
     
    },
  },

  binance: {
    swap: {
      "BTC/USDT:USDT": {
        info: {
          symbol: "BTCUSDT",
          lastPrice: "94143.40",
          indexPrice: "94191.85",
          markPrice: "94143.79",
          prevPrice24h: "94618.20",
          price24hPcnt: "-0.005018",
          highPrice24h: "95149.00",
          lowPrice24h: "93543.90",
          prevPrice1h: "94431.60",
          openInterest: "46644.329",
          openInterestValue: "4391273914.07",
          turnover24h: "6495077641.6400",
          volume24h: "68908.0590",
          fundingRate: "-0.0000119",
          nextFundingTime: "1746547200000",
          predictedDeliveryPrice: "",
          basisRate: "",
          deliveryFeeRate: "",
          deliveryTime: "0",
          ask1Size: "6.113",
          bid1Price: "94143.40",
          ask1Price: "94143.50",
          bid1Size: "13.050",
          basis: "",
          preOpenPrice: "",
          preQty: "",
          curPreListingPhase: "",
        },
        symbol: "BTC/USDT:USDT",
        markPrice: 94143.79,
        indexPrice: 94191.85,
        timestamp: 1746519294178,
        datetime: "2025-05-06T08:14:54.178Z",
        fundingRate: -0.119,
        fundingTimestamp: 1746547200000,
        fundingDatetime: "2025-05-06T16:00:00.000Z",
        interval: "8h",
        fundingRateFormat: "-0.0012%",
        nextFundingTimeFormat: "00:00:00",
        timeFormat: "16:14:54",
      },
      "ETH/USDT:USDT": {
        symbol: "BTC/USDT:USDT",
        markPrice: 0.44344,
        indexPrice: 94174.75291147163,
        timestamp: 1746519286012,
        datetime: "2025-05-06T08:14:46.012Z",
        fundingRate:0.000435,
        fundingRateFormat: "0.0044%",
        nextFundingTimeFormat: "-",
        timeFormat: "16:14:46",
      },
    },
  },

  bybit: {
    swap: {
      "BTC/USDT:USDT": {
        info: {
          symbol: "BTCUSDT",
          markPrice: "94162.90000000",
          indexPrice: "94194.26739130",
          estimatedSettlePrice: "94374.49421273",
          lastFundingRate: "0.00004328",
          interestRate: "0.00010000",
          nextFundingTime: "1746547200000",
          time: "1746519297003",
        },
        symbol: "BTC/USDT:USDT",
        markPrice: 94162.9,
        indexPrice: 94194.2673913,
        interestRate: 0.0001,
        estimatedSettlePrice: 94374.49421273,
        timestamp: 1746519297003,
        datetime: "2025-05-06T08:14:57.003Z",
        fundingRate: 0.00004328,
        fundingTimestamp: 1746547200000,
        fundingDatetime: "2025-05-06T16:00:00.000Z",
        fundingRateFormat: "0.0043%",
        nextFundingTimeFormat: "00:00:00",
        timeFormat: "16:14:57",
      },
    },
  },
};
function getFundingArbitrageOpportunities(data) {
    const symbolMap = {};
  
    // Step 1: 聚合所有交易所的 fundingRate 和 markPrice
    for (const [exchange, { swap }] of Object.entries(data)) {
      for (const [symbol, market] of Object.entries(swap)) {
        if (!symbolMap[symbol]) {
          symbolMap[symbol] = [];
        }
  
        // 获取markPrice (这里假设markPrice已经在ticker中可以获取到)
        const markPrice = market.markPrice ?? 0;
  
        symbolMap[symbol].push({
          exchange,
          fundingRate: market.fundingRate ?? 0,
          markPrice,
        });
      }
    }
  
    const results = [];
  
    // Step 2: 对每个币种，找出 fundingRate 最大和最小的两个交易所
    for (const [symbol, markets] of Object.entries(symbolMap)) {
      if (markets.length < 2) continue; // 至少两个交易所才有套利空间
  
      const sorted = markets.sort((a, b) => b.fundingRate - a.fundingRate);
      const long = sorted[0];
      const short = sorted[sorted.length - 1];
  
      // 计算净费率（保持原始格式，不乘以100）
      const netFundingRate = long.fundingRate - short.fundingRate;
  
      // 计算价差率（保持原始格式，不乘以100）
      const priceDifferenceRate = (long.markPrice - short.markPrice) / short.markPrice;
  
      // 格式化字段，转换为百分比格式
      const longFundingRateFormatted = (long.fundingRate * 100).toFixed(4) + '%';
      const shortFundingRateFormatted = (short.fundingRate * 100).toFixed(4) + '%';
      const netFundingRateFormatted = (netFundingRate * 100).toFixed(4) + '%';
      const priceDifferenceRateFormatted = (priceDifferenceRate * 100).toFixed(4) + '%';
  
      results.push({
        symbol,
        longExchange: long.exchange,
        shortExchange: short.exchange,
        longFundingRate: long.fundingRate, // 保留原始数值
        shortFundingRate: short.fundingRate, // 保留原始数值
        netFundingRate: netFundingRate, // 保留原始数值
        priceDifferenceRate: priceDifferenceRate, // 保留原始数值
        priceDifferenceRateFormatted, // 格式化后的 priceDifferenceRate
        longFundingRateFormatted, // 格式化后的 longFundingRate
        shortFundingRateFormatted, // 格式化后的 shortFundingRate
        netFundingRateFormatted, // 格式化后的 netFundingRate
      });
    }
  
    // Step 3: 按照原始净费率（netFundingRate）降序排序，若净费率相同则按价差率（priceDifferenceRate）降序排序
    return results.sort((a, b) => {
      // 主要根据原始净费率（netFundingRate）降序排序
      if (b.netFundingRate !== a.netFundingRate) {
        return b.netFundingRate - a.netFundingRate;
      }
      // 次要根据价差率（priceDifferenceRate）降序排序
      return b.priceDifferenceRate - a.priceDifferenceRate;
    });
}
  
  
const opportunities = getFundingArbitrageOpportunities(a);
console.table(opportunities);
